<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta APIs con Proxies</title>
</head>
<body>
    <h1>Consulta APIs</h1>
    <form id="consulta-form">
        <label for="dni">DNI:</label>
        <input type="text" id="dni" required>
        <button type="submit">Consultar</button>
    </form>

    <pre id="resultados">Esperando consulta...</pre>

    <script>
        let proxies = [];
        let currentProxyIndex = 0;

        // Cargar proxies desde proxies.txt
        async function cargarProxies() {
            try {
                const respuesta = await fetch('proxies.txt');
                const texto = await respuesta.text();
                proxies = texto.split('\n')
                    .map(p => p.trim())
                    .filter(p => p);
                console.log('Proxies cargados:', proxies.length);
            } catch (error) {
                console.error('Error cargando proxies:', error);
            }
        }

        // Obtener siguiente proxy con rotaciÃ³n
        function getNextProxy() {
            if (proxies.length === 0) return null;
            const proxy = proxies[currentProxyIndex];
            currentProxyIndex = (currentProxyIndex + 1) % proxies.length;
            return proxy;
        }

        async function consultarUrlConProxy(url, proxy) {
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 10000);

            try {
                const proxyUrl = `http://${proxy}`;
                const finalUrl = url;
                
                const opciones = {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'User-Agent': 'Mozilla/5.0',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    signal: controller.signal,
                    mode: 'cors'
                };

                const respuesta = await fetch(finalUrl, {
                    ...opciones,
                    headers: {
                        ...opciones.headers,
                        'Proxy-Authorization': `Basic ${btoa(proxy)}`
                    }
                });

                clearTimeout(timeout);

                if (!respuesta.ok) {
                    throw new Error(`Error HTTP ${respuesta.status}`);
                }

                const datos = await respuesta.json();
                return { success: true, datos };
            } catch (error) {
                clearTimeout(timeout);
                return { 
                    success: false, 
                    error: error.name === 'AbortError' ? 'Timeout' : error.message 
                };
            }
        }

        async function consultarUrl(url, maxIntentos = 3) {
            // Solo usar proxies para credicuotas
            const necesitaProxy = url.includes('credicuotas.com.ar');
            
            if (!necesitaProxy) {
                try {
                    const respuesta = await fetch(url, {
                        headers: {
                            'Accept': 'application/json',
                            'User-Agent': 'Mozilla/5.0'
                        }
                    });
                    const datos = await respuesta.json();
                    return { success: true, datos };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            }

            // Para credicuotas, intentar con diferentes proxies
            for (let intento = 0; intento < maxIntentos; intento++) {
                const proxy = getNextProxy();
                if (!proxy) {
                    return { success: false, error: 'No hay proxies disponibles' };
                }

                const resultado = await consultarUrlConProxy(url, proxy);
                if (resultado.success || 
                    (resultado.error && !resultado.error.includes('429'))) {
                    return resultado;
                }

                // Esperar antes de intentar con otro proxy
                await new Promise(resolve => setTimeout(resolve, 1000));
            }

            return { success: false, error: 'Agotados todos los intentos con proxies' };
        }

        async function consultarApis(dni) {
            const urls = [
                `https://clientes.credicuotas.com.ar/v1/onboarding/resolvecustomers/${dni}`,
                `https://app.iosep.gob.ar/WsRest/api/Afiliados/GetAfiliadosC?Dni=${dni}`,
                `https://teldni-g77k.onrender.com/${dni}`,
                `https://fiscalizar.seguridadvial.gob.ar/api/licencias?numeroDocumento=${dni}&sexo=M`,
                `https://fiscalizar.seguridadvial.gob.ar/retenciones?numeroDocumento=${dni}&sexo=M`
            ];

            const resultados = [];

            for (const url of urls) {
                const resultado = await consultarUrl(url);
                resultados.push({
                    url,
                    ...(resultado.success ? { datos: resultado.datos } : { error: resultado.error })
                });
            }

            return resultados;
        }

        document.getElementById('consulta-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const dni = document.getElementById('dni').value;
            const resultadosDiv = document.getElementById('resultados');
            resultadosDiv.textContent = 'Realizando consultas...';

            try {
                const resultados = await consultarApis(dni);
                resultadosDiv.textContent = JSON.stringify(resultados, null, 2);
            } catch (error) {
                resultadosDiv.textContent = `Error general: ${error.message}`;
            }
        });

        // Inicializar
        cargarProxies();
    </script>
</body>
</html>
