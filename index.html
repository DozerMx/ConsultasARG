<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta APIs Frontend Only</title>
    <style>
        .error { color: red; }
        .success { color: green; }
        .loading { color: blue; }
        pre { white-space: pre-wrap; word-wrap: break-word; }
        .result-item { 
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
    <h1>Consulta APIs</h1>
    <form id="consulta-form">
        <label for="dni">DNI:</label>
        <input type="text" id="dni" required pattern="[0-9]{7,8}" title="DNI debe tener 7 u 8 dígitos">
        <label for="sexo">Sexo:</label>
        <select id="sexo" required>
            <option value="M">Masculino</option>
            <option value="F">Femenino</option>
        </select>
        <button type="submit">Consultar</button>
    </form>

    <div id="resultados"></div>

    <script>
        const CORS_PROXIES = [
            'https://corsproxy.io/?',
            'https://api.allorigins.win/raw?url=',
            'https://api.codetabs.com/v1/proxy?quest='
        ];

        let currentProxyIndex = 0;

        function getNextProxy() {
            const proxy = CORS_PROXIES[currentProxyIndex];
            currentProxyIndex = (currentProxyIndex + 1) % CORS_PROXIES.length;
            return proxy;
        }

        async function fetchWithProxy(url, options = {}) {
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 15000);

            // Intentar con diferentes proxies
            for (let i = 0; i < CORS_PROXIES.length; i++) {
                try {
                    const proxyUrl = `${getNextProxy()}${encodeURIComponent(url)}`;
                    
                    const response = await fetch(proxyUrl, {
                        ...options,
                        signal: controller.signal,
                        headers: {
                            'Accept': 'application/json',
                            'User-Agent': 'Mozilla/5.0',
                            ...options.headers
                        }
                    });

                    clearTimeout(timeout);

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    return { success: true, data };
                } catch (error) {
                    if (i === CORS_PROXIES.length - 1) {
                        clearTimeout(timeout);
                        return {
                            success: false,
                            error: error.name === 'AbortError' ? 
                                'Tiempo de espera agotado' : 
                                `Error: ${error.message}`
                        };
                    }
                    // Si falla, continuará con el siguiente proxy
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
        }

        async function consultarApis(dni, sexo) {
            const apis = [
                {
                    nombre: 'Credicuotas',
                    url: `https://clientes.credicuotas.com.ar/v1/onboarding/resolvecustomers/${dni}`
                },
                {
                    nombre: 'IOSEP',
                    url: `https://app.iosep.gob.ar/WsRest/api/Afiliados/GetAfiliadosC?Dni=${dni}`
                },
                {
                    nombre: 'TelDNI',
                    url: `https://teldni-g77k.onrender.com/${dni}`
                },
                {
                    nombre: 'Licencias',
                    url: `https://fiscalizar.seguridadvial.gob.ar/api/licencias?numeroDocumento=${dni}&sexo=${sexo}`
                },
                {
                    nombre: 'Retenciones',
                    url: `https://fiscalizar.seguridadvial.gob.ar/retenciones?numeroDocumento=${dni}&sexo=${sexo}`
                }
            ];

            const resultados = [];
            const resultadosDiv = document.getElementById('resultados');
            resultadosDiv.innerHTML = '';

            for (const api of apis) {
                const divResultado = document.createElement('div');
                divResultado.className = 'result-item';
                divResultado.innerHTML = `
                    <h3>${api.nombre}</h3>
                    <p class="loading">Consultando...</p>
                `;
                resultadosDiv.appendChild(divResultado);

                try {
                    const resultado = await fetchWithProxy(api.url);
                    
                    divResultado.innerHTML = `
                        <h3>${api.nombre}</h3>
                        <pre class="${resultado.success ? 'success' : 'error'}">
                            ${JSON.stringify(resultado.success ? resultado.data : resultado.error, null, 2)}
                        </pre>
                    `;

                    resultados.push({
                        nombre: api.nombre,
                        url: api.url,
                        ...(resultado.success ? { datos: resultado.data } : { error: resultado.error })
                    });
                } catch (error) {
                    divResultado.innerHTML = `
                        <h3>${api.nombre}</h3>
                        <pre class="error">Error: ${error.message}</pre>
                    `;
                    resultados.push({
                        nombre: api.nombre,
                        url: api.url,
                        error: error.message
                    });
                }
            }

            return resultados;
        }

        document.getElementById('consulta-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const dni = document.getElementById('dni').value;
            const sexo = document.getElementById('sexo').value;
            
            try {
                await consultarApis(dni, sexo);
            } catch (error) {
                document.getElementById('resultados').innerHTML = 
                    `<p class="error">Error general: ${error.message}</p>`;
            }
        });
    </script>
</body>
</html>
