<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta APIs con Rate Limiting</title>
</head>
<body>
    <h1>Consulta APIs</h1>
    <form id="consulta-form">
        <label for="dni">DNI:</label>
        <input type="text" id="dni" required>
        <button type="submit">Consultar</button>
    </form>

    <pre id="resultados">Esperando consulta...</pre>

    <script>
        // Control de rate limiting
        const rateLimits = {
            'credicuotas.com.ar': {
                requests: [],
                maxRequests: 2,
                timeWindow: 60000 // 60 segundos
            }
        };

        function canMakeRequest(domain) {
            const now = Date.now();
            const limit = rateLimits[domain];
            
            if (!limit) return true;
            
            // Limpiar solicitudes antiguas
            limit.requests = limit.requests.filter(time => now - time < limit.timeWindow);
            
            // Verificar si podemos hacer más solicitudes
            if (limit.requests.length < limit.maxRequests) {
                limit.requests.push(now);
                return true;
            }
            
            return false;
        }

        async function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function consultarUrl(url, dni) {
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 15000); // Aumentado a 15 segundos
            
            const domain = new URL(url).hostname;
            
            try {
                // Verificar rate limiting
                if (!canMakeRequest(domain)) {
                    await sleep(5000); // Esperar 5 segundos si excedimos el límite
                }

                const proxyUrl = `https://cors-anywhere.herokuapp.com/${url}`;
                
                const opciones = {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'User-Agent': 'Mozilla/5.0',
                        'Origin': window.location.origin
                    },
                    signal: controller.signal
                };

                const respuesta = await fetch(proxyUrl, opciones);
                clearTimeout(timeout);
                
                if (respuesta.status === 429) {
                    throw new Error('Rate limit excedido. Esperando...');
                }
                
                if (!respuesta.ok) {
                    // Ignorar error 404 para retenciones y devolver array vacío
                    if (respuesta.status === 404 && url.includes('retenciones')) {
                        return { success: true, datos: [] };
                    }
                    throw new Error(`Error HTTP ${respuesta.status}`);
                }
                
                const datos = await respuesta.json();
                
                // Normalizar respuestas vacías
                if (Array.isArray(datos) && datos.length === 0) {
                    return { success: true, datos: { mensaje: "No se encontraron datos" } };
                }
                
                return { success: true, datos };
            } catch (error) {
                clearTimeout(timeout);
                
                if (error.name === 'AbortError') {
                    return { success: false, error: 'La consulta excedió el tiempo límite' };
                }
                
                return { success: false, error: error.message };
            }
        }

        async function consultarApis(dni) {
            const urls = [
                `https://clientes.credicuotas.com.ar/v1/onboarding/resolvecustomers/${dni}`,
                `https://app.iosep.gob.ar/WsRest/api/Afiliados/GetAfiliadosC?Dni=${dni}`,
                `https://teldni-g77k.onrender.com/${dni}`,
                `https://fiscalizar.seguridadvial.gob.ar/api/licencias?numeroDocumento=${dni}&sexo=M`,
                `https://fiscalizar.seguridadvial.gob.ar/retenciones?numeroDocumento=${dni}&sexo=M`
            ];

            const resultados = [];

            for (const url of urls) {
                let resultado = null;
                
                // Intentar hasta 3 veces con retardos incrementales
                for (let intento = 0; intento < 3; intento++) {
                    resultado = await consultarUrl(url, dni);
                    
                    if (resultado.success || 
                        (resultado.error && !resultado.error.includes('Rate limit'))) {
                        break;
                    }
                    
                    // Esperar antes de reintentar (2, 4, 8 segundos)
                    await sleep(Math.pow(2, intento + 1) * 1000);
                }
                
                if (resultado.success) {
                    resultados.push({ url, datos: resultado.datos });
                } else {
                    resultados.push({ url, error: resultado.error });
                }
            }

            return resultados;
        }

        document.getElementById('consulta-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const dni = document.getElementById('dni').value;
            const resultadosDiv = document.getElementById('resultados');
            resultadosDiv.textContent = 'Realizando consultas...';

            try {
                const resultados = await consultarApis(dni);
                resultadosDiv.textContent = JSON.stringify(resultados, null, 2);
            } catch (error) {
                resultadosDiv.textContent = `Error general: ${error.message}`;
            }
        });
    </script>
</body>
</html>
